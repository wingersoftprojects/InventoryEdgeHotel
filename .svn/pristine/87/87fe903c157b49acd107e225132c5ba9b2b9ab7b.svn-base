import java.io.Serializable;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import javax.faces.application.FacesMessage;
import javax.faces.bean.*;
import javax.faces.context.FacesContext;

@ManagedBean
@SessionScoped
public class TransactionTypeBean implements Serializable {

    private static final long serialVersionUID = 1L;
    private List<TransactionType> TransactionTypes;
    private String ActionMessage;
    private TransactionType SelectedTransactionType = null;
    private int SelectedTransactionTypeId;
    private String SearchTransactionTypeName = "";

    public int transNeeds(int aTransId, String aNeeded) {
        /*
         1	PURCHASE INVOICE
         2	SALE INVOICE
         3	DISPOSE
         4	TRANSFER
         5	ITEM
         6	PAYMENT
         7	UNPACK
         8	PURCHASE ORDER
         9	GOODS RECEIVED
         10	SALE QUOTATION
         11	SALE ORDER
         12	GOODS DELIVERY
         13	TRANSFER REQUEST
         */
        int x = 0;
        switch (aNeeded) {
            case "total":
                //1,2,8,10,11
                break;
            case "payment":
                //2
                break;
            case "loyalty":
                //2
                break;
            case "delivery":
                //8,10,11,12
                break;
            case "authorise":
                //4,13,
                break;
            case "gen_terms":
                //
                break;
            case "pay_terms":
                //10
                break;
            case "cash_discount":
                //1,2,8,10,11
                if(aTransId==1 || aTransId==2 || aTransId==8 || aTransId==10 || aTransId==11){
                    x=1;
                }else{
                    x=0;
                }
                break;
        }
        return x;
    }

    public void updateTransactionTypes(List<TransactionType> aTransactionTypes) {
        String sql = null;
        String msg = null;
        UserDetail aCurrentUserDetail = new GeneralUserSetting().getCurrentUser();
        List<GroupRight> aCurrentGroupRights = new GeneralUserSetting().getCurrentGroupRights();
        GroupRightBean grb = new GroupRightBean();

        if (grb.IsUserGroupsFunctionAccessAllowed(aCurrentUserDetail, aCurrentGroupRights, "SETTING", "Edit") == 0) {
            msg = "YOU ARE NOT ALLOWED TO USE THIS FUNCTION, CONTACT SYSTEM ADMINISTRATOR...";
            FacesContext.getCurrentInstance().addMessage("Save", new FacesMessage(msg));
        } else {
            List<TransactionType> att = aTransactionTypes;
            int ListItemIndex = 0;
            int ListItemNo = att.size();
            while (ListItemIndex < ListItemNo) {
                this.updateTransactionType(att.get(ListItemIndex));
                ListItemIndex = ListItemIndex + 1;
            }
        }
    }

    public void updateTransactionType(TransactionType tt) {
        String sql = null;
        if (tt.getTransactionTypeId() > 0) {
            sql = "{call sp_update_transaction_type(?,?,?,?,?,?,?,?,?)}";
            try (
                    Connection conn = DBConnection.getMySQLConnection();
                    CallableStatement cs = conn.prepareCall(sql);) {
                if (tt.getTransactionTypeId() > 0) {
                    cs.setInt("in_transaction_type_id", tt.getTransactionTypeId());
                    cs.setString("in_transaction_type_name", tt.getTransactionTypeName());
                    cs.setString("in_transactor_label", tt.getTransactorLabel());
                    cs.setString("in_transaction_number_label", tt.getTransactionNumberLabel());
                    cs.setString("in_transaction_output_label", tt.getTransactionOutputLabel());
                    cs.setString("in_bill_transactor_label", tt.getBillTransactorLabel());
                    cs.setString("in_transaction_ref_label", tt.getTransactionRefLabel());
                    cs.setString("in_transaction_date_label", tt.getTransactionDateLabel());
                    cs.setString("in_transaction_user_label", tt.getTransactionUserLabel());
                    cs.executeUpdate();
                }
            } catch (SQLException se) {
                System.err.println(se.getMessage());
            }
        }
    }

    public TransactionType getTransactionType(int TtId) {
        String sql = "SELECT * FROM transaction_type WHERE transaction_type_id=?";
        ResultSet rs = null;
        try (
                Connection conn = DBConnection.getMySQLConnection();
                PreparedStatement ps = conn.prepareStatement(sql);) {
            ps.setInt(1, TtId);
            rs = ps.executeQuery();
            if (rs.next()) {
                TransactionType tt = new TransactionType();
                tt.setTransactionTypeId(rs.getInt("transaction_type_id"));
                tt.setTransactionTypeName(rs.getString("transaction_type_name"));
                tt.setTransactorLabel(rs.getString("transactor_label"));
                tt.setTransactionNumberLabel(rs.getString("transaction_number_label"));
                tt.setTransactionOutputLabel(rs.getString("transaction_output_label"));
                tt.setBillTransactorLabel(rs.getString("bill_transactor_label"));
                tt.setTransactionRefLabel(rs.getString("transaction_ref_label"));
                tt.setTransactionDateLabel(rs.getString("transaction_date_label"));
                tt.setTransactionUserLabel(rs.getString("transaction_user_label"));
                return tt;
            } else {
                return null;
            }
        } catch (SQLException se) {
            System.err.println(se.getMessage());
            return null;
        } finally {
            if (rs != null) {
                try {
                    rs.close();
                } catch (SQLException ex) {
                    System.err.println(ex.getMessage());
                }
            }
        }

    }

    public void deleteTransactionType() {
        this.deleteTransactionTypeById(this.SelectedTransactionTypeId);
    }

    public void deleteTransactionTypeByObject(TransactionType tt) {
        this.deleteTransactionTypeById(tt.getTransactionTypeId());
    }

    public void deleteTransactionTypeById(int TtId) {
        String sql = "DELETE FROM transaction_type WHERE transaction_type_id=?";
        String msg;
        UserDetail aCurrentUserDetail = new GeneralUserSetting().getCurrentUser();
        List<GroupRight> aCurrentGroupRights = new GeneralUserSetting().getCurrentGroupRights();
        GroupRightBean grb = new GroupRightBean();

        if (grb.IsUserGroupsFunctionAccessAllowed(aCurrentUserDetail, aCurrentGroupRights, "SETTING", "Delete") == 0) {
            msg = "YOU ARE NOT ALLOWED TO USE THIS FUNCTION, CONTACT SYSTEM ADMINISTRATOR...";
            FacesContext.getCurrentInstance().addMessage("Save", new FacesMessage(msg));
        } else {
            try (
                    Connection conn = DBConnection.getMySQLConnection();
                    PreparedStatement ps = conn.prepareStatement(sql);) {
                ps.setInt(1, TtId);
                ps.executeUpdate();
                this.setActionMessage("Deleted Successfully!");
            } catch (SQLException se) {
                System.err.println(se.getMessage());
                this.setActionMessage("TransactionType NOT deleted");
            }
        }
    }

    public void displayTransactionType(TransactionType PmFrom, TransactionType PmTo) {
        PmTo.setTransactionTypeId(PmFrom.getTransactionTypeId());
        PmTo.setTransactionTypeName(PmFrom.getTransactionTypeName());
        PmTo.setTransactorLabel(PmFrom.getTransactorLabel());
        PmTo.setTransactionNumberLabel(PmFrom.getTransactionNumberLabel());
        PmTo.setTransactionOutputLabel(PmFrom.getTransactionOutputLabel());
    }

    public void clearTransactionType(TransactionType tt) {
        tt.setTransactionTypeId(0);
        tt.setTransactionTypeName("");
        tt.setTransactorLabel("");
        tt.setTransactionNumberLabel("");
        tt.setTransactionOutputLabel("");
        tt.setBillTransactorLabel("");
        tt.setTransactionRefLabel("");
        tt.setTransactionDateLabel("");
        tt.setTransactionUserLabel("");
    }

    /**
     * @return the TransactionTypes
     */
    public List<TransactionType> getTransactionTypes() {
        String sql;
        sql = "SELECT * FROM transaction_type ORDER BY transaction_type_name ASC";
        ResultSet rs = null;
        TransactionTypes = new ArrayList<TransactionType>();
        try (
                Connection conn = DBConnection.getMySQLConnection();
                PreparedStatement ps = conn.prepareStatement(sql);) {
            rs = ps.executeQuery();
            while (rs.next()) {
                TransactionType tt = new TransactionType();
                tt.setTransactionTypeId(rs.getInt("transaction_type_id"));
                tt.setTransactionTypeName(rs.getString("transaction_type_name"));
                tt.setTransactorLabel(rs.getString("transactor_label"));
                tt.setTransactionNumberLabel(rs.getString("transaction_number_label"));
                tt.setTransactionOutputLabel(rs.getString("transaction_output_label"));
                tt.setBillTransactorLabel(rs.getString("bill_transactor_label"));
                tt.setTransactionRefLabel(rs.getString("transaction_ref_label"));
                tt.setTransactionDateLabel(rs.getString("transaction_date_label"));
                tt.setTransactionUserLabel(rs.getString("transaction_user_label"));
                TransactionTypes.add(tt);
            }
        } catch (SQLException se) {
            System.err.println(se.getMessage());
        } finally {
            if (rs != null) {
                try {
                    rs.close();
                } catch (SQLException ex) {
                    System.err.println(ex.getMessage());
                }
            }
        }
        return TransactionTypes;
    }

    public List<TransactionType> getTransTypesByTcTypeTransId(long aTransactionId, String aTransactorType) {
        String sql;
        int aTransactionTypeId = 0;
        List<TransactionType> tts;
        Trans t;

        if (aTransactionId > 0) {
            t = new TransBean().getTrans(aTransactionId);
            aTransactionTypeId = t.getTransactionTypeId();
        } else {
            if (aTransactorType.equals("CUSTOMER") || aTransactorType.equals("SCHEME")) {
                aTransactionTypeId = 2;//SALE
            } else if (aTransactorType.equals("SUPPLIER")) {
                aTransactionTypeId = 1;//SUPPLIER
            }
        }
        sql = "SELECT * FROM transaction_type WHERE transaction_type_id=" + aTransactionTypeId;
        ResultSet rs = null;
        tts = new ArrayList<TransactionType>();
        try (
                Connection conn = DBConnection.getMySQLConnection();
                PreparedStatement ps = conn.prepareStatement(sql);) {
            rs = ps.executeQuery();
            while (rs.next()) {
                TransactionType tt = new TransactionType();
                tt.setTransactionTypeId(rs.getInt("transaction_type_id"));
                tt.setTransactionTypeName(rs.getString("transaction_type_name"));
                tt.setTransactorLabel(rs.getString("transactor_label"));
                tt.setTransactionNumberLabel(rs.getString("transaction_number_label"));
                tt.setTransactionOutputLabel(rs.getString("transaction_output_label"));
                tt.setBillTransactorLabel(rs.getString("bill_transactor_label"));
                tt.setTransactionRefLabel(rs.getString("transaction_ref_label"));
                tt.setTransactionDateLabel(rs.getString("transaction_date_label"));
                tt.setTransactionUserLabel(rs.getString("transaction_user_label"));
                tts.add(tt);
            }
        } catch (SQLException se) {
            System.err.println(se.getMessage());
        } finally {
            if (rs != null) {
                try {
                    rs.close();
                } catch (SQLException ex) {
                    System.err.println(ex.getMessage());
                }
            }
        }
        return tts;
    }

    /**
     * @param TransactionTypes the TransactionTypes to set
     */
    public void setTransactionTypes(List<TransactionType> TransactionTypes) {
        this.TransactionTypes = TransactionTypes;
    }

    /**
     * @return the SelectedTransactionType
     */
    public TransactionType getSelectedTransactionType() {
        return SelectedTransactionType;
    }

    /**
     * @param SelectedTransactionType the SelectedTransactionType to set
     */
    public void setSelectedTransactionType(TransactionType SelectedTransactionType) {
        this.SelectedTransactionType = SelectedTransactionType;
    }

    /**
     * @return the SelectedTransactionTypeId
     */
    public int getSelectedTransactionTypeId() {
        return SelectedTransactionTypeId;
    }

    /**
     * @param SelectedTransactionTypeId the SelectedTransactionTypeId to set
     */
    public void setSelectedTransactionTypeId(int SelectedTransactionTypeId) {
        this.SelectedTransactionTypeId = SelectedTransactionTypeId;
    }

    /**
     * @return the SearchTransactionTypeName
     */
    public String getSearchTransactionTypeName() {
        return SearchTransactionTypeName;
    }

    /**
     * @param SearchTransactionTypeName the SearchTransactionTypeName to set
     */
    public void setSearchTransactionTypeName(String SearchTransactionTypeName) {
        this.SearchTransactionTypeName = SearchTransactionTypeName;
    }

    /**
     * @return the ActionMessage
     */
    public String getActionMessage() {
        return ActionMessage;
    }

    /**
     * @param ActionMessage the ActionMessage to set
     */
    public void setActionMessage(String ActionMessage) {
        this.ActionMessage = ActionMessage;
    }

}
